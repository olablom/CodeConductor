name: CodeConductor Tests (Windows)

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    PYTHONHASHSEED: 0
    CODECONDUCTOR_SEED: 1337
    # Global CPU-lock environment variables
    CC_TESTING_MODE: "1"
    CC_GPU_DISABLED: "1"
    CC_FORCE_GPU: "0"
    CC_HARD_CPU_ONLY: "1"
    CUDA_VISIBLE_DEVICES: ""
    HF_HUB_OFFLINE: "1"
    TORCH_USE_CUDA_DISABLED: "1"
    VLLM_NO_CUDA: "1"
    # Block LM Studio during testing
    ENGINE_BACKENDS: "ollama"
    LMSTUDIO_DISABLE: "1"
    LMSTUDIO_CLI_DISABLE: "1"
    DISCOVERY_DISABLE: "1"
    ENGINE_DISCOVERY_MODE: "preloaded_only"

jobs:
    test-windows:
        runs-on: windows-latest

        strategy:
            matrix:
                python-version: [3.11]

        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.sha }}
                  fetch-depth: 0

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Cache pip dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pytest-json-report pytest-cov pytest-timeout

            - name: Install package in editable mode
              run: |
                  pip install -e .[test]

            - name: Run CPU-locked tests with JSON report
              env:
                  PYTHONPATH: ${{ github.workspace }}/src
              run: |
                  mkdir -p .artifacts
                  python -m pytest tests/ -q -m "not gpu and not vllm" --json-report --json-report-file .artifacts/report.json

            - name: Verify Windows-specific test results
              run: |
                  python -c "import json, sys; d = json.load(open('.artifacts/report.json', 'r', encoding='utf-8')); tests = d.get('tests', []); passed = len([t for t in tests if t.get('outcome') == 'passed']); failed = len([t for t in tests if t.get('outcome') == 'failed']); skipped = len([t for t in tests if t.get('outcome') == 'skipped']); xfailed = len([t for t in tests if t.get('outcome') == 'xfailed']); print(f'Windows Test Results: {passed} passed, {failed} failed, {skipped} skipped, {xfailed} xfailed'); print(f'ℹ️ {skipped} tests skipped (expected on Windows due to vLLM dependencies)' if skipped > 0 else ''); sys.exit(1) if failed > 0 else print('✅ Windows tests: All passed!')"

            - name: Run CPU-locked tests with coverage
              env:
                  PYTHONPATH: ${{ github.workspace }}/src
              run: |
                  python -m pytest -m "not gpu and not vllm" --cov=codeconductor --cov-config=.coveragerc --cov-report=term-missing --cov-report=html

            - name: Upload test report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-report-windows
                  path: .artifacts/report.json

            - name: Upload coverage HTML
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-html-windows
                  path: htmlcov/

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results-windows
                  path: |
                      .artifacts/
                      htmlcov/
                      *.log
